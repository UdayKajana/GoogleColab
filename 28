import apache_beam as beam
from apache_beam.options.pipeline_options import PipelineOptions
import argparse
import logging

def run(argv=None):
    parser = argparse.ArgumentParser()
    parser.add_argument(
        '--query',
        required=True,
        help='BigQuery SQL query to execute'
    )
    parser.add_argument(
        '--project',
        required=True,
        help='GCP Project ID'
    )
    
    # Parse arguments
    known_args, pipeline_args = parser.parse_known_args(argv)
    
    # Ensure project is in pipeline_args
    if '--project' not in ' '.join(pipeline_args):
        pipeline_args.extend(['--project', known_args.project])
    
    # Create pipeline options with all arguments
    pipeline_options = PipelineOptions(pipeline_args)
    
    # Set up logging
    logging.getLogger().setLevel(logging.INFO)
    
    # Create and run pipeline
    with beam.Pipeline(options=pipeline_options) as pipeline:
        (pipeline 
         | 'ReadFromBigQuery' >> beam.io.ReadFromBigQuery(
             query=known_args.query,
             use_standard_sql=True,
             project=known_args.project)  # This project parameter is used for the BigQuery client
         | 'LogRows' >> beam.Map(lambda row: logging.info(f"Row Data: {row}"))
        )

if __name__ == '__main__':
    run()


gcloud dataflow flex-template run bigquery123 \
--template-file-gcs-location gs://vznet-test/wireline_churn_test/src/template.json \
--region us-east4 \
--parameters query="SELECT * FROM vz-it-np-gudv-dev-vzntdo-0.vzn_nsdl_common_core_tbls.echo_ticket_opened_proc_v0 LIMIT 10",project="vz-it-np-gudv-dev-vzntdo-0" \
--temp-location=gs://vznet-test/wireline_churn_test/tmp/ \
--num-workers 2 \
--max-workers 2 \
--worker-machine-type n2-standard-2 \
--disable-public-ips \
--network=shared-np-east \
--dataflow-kms-key=projects/vz-it-np-d0sv-vsadkms-0/locations/us-east4/keyRings/vz-it-np-kr-aid/cryptoKeys/vz-it-np-kms-gudv \
--subnetwork=https://www.googleapis.com/compute/v1/projects/vz-it-np-exhv-sharedvpc-228116/regions/us-east4/subnetworks/shared-np-east-green-subnet-2 \
--service-account-email sa-dev-gudv-app-vzntdo-0@vz-it-np-gudv-dev-vzntdo-0.iam.gserviceaccount.com
