# pipeline.py
import apache_beam as beam
from apache_beam.options.pipeline_options import PipelineOptions
from apache_beam.options.pipeline_options import StandardOptions
from apache_beam.options.pipeline_options import GoogleCloudOptions
from apache_beam.io.gcp.bigquery import ReadFromBigQuery

def run():
    # Define custom options
    class CustomOptions(PipelineOptions):
        @classmethod
        def _add_argparse_args(cls, parser):
            parser.add_value_provider_argument('--query', type=str, help='BigQuery SQL query')

    # Parse command line arguments
    pipeline_options = CustomOptions()
    
    # Ensure project is set
    google_cloud_options = pipeline_options.view_as(GoogleCloudOptions)
    if not google_cloud_options.project:
        raise ValueError("Project must be specified.")
    
    # Set runner (DataflowRunner for cloud execution)
    pipeline_options.view_as(StandardOptions).runner = 'DataflowRunner'

    # Create pipeline
    with beam.Pipeline(options=pipeline_options) as pipeline:
        # Read from BigQuery using the provided query
        records = pipeline | 'ReadFromBigQuery' >> ReadFromBigQuery(
            query=pipeline_options.query,
            use_standard_sql=True,
            gcs_location=pipeline_options.temp_location
        )
        
        # Add your transformations here
        # Example: records | 'SomeTransform' >> beam.Map(some_function)

if __name__ == '__main__':
    run()

# metadata.json
{
    "name": "Bigquery to GCS Pipeline",
    "description": "A template for reading from BigQuery and processing data",
    "parameters": [
        {
            "name": "query",
            "label": "BigQuery SQL query",
            "helpText": "The SQL query to execute",
            "isOptional": false,
            "regexes": [],
            "paramType": "TEXT"
        }
    ],
    "defaultEnvironment": {
        "tempLocation": "gs://vznet-test/wireline_churn_test/tmp/",
        "network": "shared-np-east",
        "subnetwork": "https://www.googleapis.com/compute/v1/projects/vz-it-np-exhv-sharedvpc-228116/regions/us-east4/subnetworks/shared-np-east-green-subnet-2",
        "serviceAccountEmail": "sa-dev-gudv-app-vzntdo-0@vz-it-np-gudv-dev-vzntdo-0.iam.gserviceaccount.com"
    }
}

# Dockerfile
FROM apache/beam_python3.9_sdk:2.52.0

WORKDIR /template

COPY requirements.txt .
COPY pipeline.py .

RUN pip install -r requirements.txt

# requirements.txt
apache-beam[gcp]==2.52.0
