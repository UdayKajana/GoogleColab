import apache_beam as beam
from apache_beam.options.pipeline_options import PipelineOptions
from apache_beam.options.pipeline_options import StandardOptions
from apache_beam.options.pipeline_options import GoogleCloudOptions
from apache_beam.io.gcp.bigquery import ReadFromBigQuery
import argparse

def run(argv=None):
    """Main entry point."""
    parser = argparse.ArgumentParser()
    parser.add_argument(
        '--query',
        required=True,
        help='BigQuery SQL query to execute'
    )
    
    # Parse the known args and pass the remainder to PipelineOptions
    known_args, pipeline_args = parser.parse_known_args(argv)
    
    # Create pipeline options with remaining args
    pipeline_options = PipelineOptions(pipeline_args)
    
    # Set runner
    pipeline_options.view_as(StandardOptions).runner = 'DataflowRunner'
    
    # Setup Google Cloud Options
    google_cloud_options = pipeline_options.view_as(GoogleCloudOptions)
    
    # Create and run pipeline
    pipeline = beam.Pipeline(options=pipeline_options)
    
    # Read from BigQuery
    records = pipeline | 'ReadFromBigQuery' >> ReadFromBigQuery(
        query=known_args.query,
        use_standard_sql=True,
        gcs_location=google_cloud_options.temp_location
    )
    
    # Add your transformations here
    transformed_records = records | 'ExampleTransform' >> beam.Map(lambda record: record)
    
    # Run the pipeline
    result = pipeline.run()
    result.wait_until_finish()

if __name__ == '__main__':
    run()



# Build the Docker image (unchanged)
gcloud builds submit --tag us-east4-docker.pkg.dev/vz-it-np-gudv-dev-vzntdo-0/vznet/pipeline_env:V1 .

# Build the Flex Template (unchanged)
gcloud dataflow flex-template build gs://vznet-test/wireline_churn_test/src/template.json \
    --image us-east4-docker.pkg.dev/vz-it-np-gudv-dev-vzntdo-0/vznet/pipeline_env:V1 \
    --sdk-language "PYTHON" \
    --metadata-file metadata.json

# Run the Flex Template
gcloud dataflow flex-template run bigquery-pipeline \
    --template-file-gcs-location gs://vznet-test/wireline_churn_test/src/template.json \
    --parameters="\
        query=SELECT * FROM vz-it-np-gudv-dev-vzntdo-0.vzn_nsdl_common_core_tbls.echo_ticket_opened_proc_v0 LIMIT 10,\
        project=vz-it-np-gudv-dev-vzntdo-0,\
        temp_location=gs://vznet-test/wireline_churn_test/tmp/,\
        network=shared-np-east,\
        subnetwork=https://www.googleapis.com/compute/v1/projects/vz-it-np-exhv-sharedvpc-228116/regions/us-east4/subnetworks/shared-np-east-green-subnet-2,\
        service_account_email=sa-dev-gudv-app-vzntdo-0@vz-it-np-gudv-dev-vzntdo-0.iam.gserviceaccount.com" \
    --project vz-it-np-gudv-dev-vzntdo-0 \
    --region us-east4 \
    --disable-public-ips \
    --dataflow-kms-key projects/vz-it-np-d0sv-vsadkms-0/locations/us-east4/keyRings/vz-it-np-kr-aid/cryptoKeys/vz-it-np-kms-gudv
