from datetime import datetime
from airflow import DAG
from airflow.providers.google.cloud.operators.dataflow import DataflowStartFlexTemplateOperator

default_args = {
    'owner': 'airflow',
    'depends_on_past': False,
    'email_on_failure': False,
    'email_on_retry': False,
    'retries': 1,
}

dag = DAG(
    dag_id='trigger_flex_template_dag',
    default_args=default_args,
    description='DAG to trigger Dataflow Flex Template',
    schedule_interval=None,  # Triggered manually or via external scheduler
    start_date=datetime(2023, 1, 1),
    catchup=False,
)

dataflow_flex_template_task = DataflowStartFlexTemplateOperator(
    task_id='trigger_flex_template',
    body={
        "launchParameter": {
            "jobName": "bigquery-pipeline-ttt",
            "parameters": {
                "query": "SELECT * FROM vz-it-np-gudv-dev-vzntdo-0.vzn_nsdl_common_core_tbls.echo_ticket_opened_proc_v0 LIMIT 10",
                "gcs_folder_path": "gs://vznet-test/wireline_churn_test/tmp/",
                "service_account_email": "sa-dev-gudv-app-vzntdo-0@vz-it-np-gudv-dev-vzntdo-0.iam.gserviceaccount.com"
            },
            "environment": {
                "numWorkers": 2,
                "maxWorkers": 2,
                "workerMachineType": "n2-standard-2",
                "network": "shared-np-east",
                "subnetwork": "https://www.googleapis.com/compute/v1/projects/vz-it-np-exhv-sharedvpc-228116/regions/us-east4/subnetworks/shared-np-east-green-subnet-2",
                "tempLocation": "gs://vznet-test/wireline_churn_test/tmp/",
                "ipConfiguration": "WORKER_IP_PRIVATE",
                "kmsKeyName": "projects/vz-it-np-d0sv-vsadkms-0/locations/us-east4/keyRings/vz-it-np-kr-aid/cryptoKeys/vz-it-np-kms-gudv"
            },
            "containerSpecGcsPath": "gs://vznet-test/wireline_churn_test/src/template.json"
        }
    },
    project_id="vz-it-np-gudv-dev-vzntdo-0",
    location="us-east4",
    dag=dag,
)

dataflow_flex_template_task
