import apache_beam as beam
from apache_beam.options.pipeline_options import PipelineOptions
from apache_beam.options.pipeline_options import StandardOptions
import argparse
import logging

logging.getLogger().setLevel(logging.ERROR)

class TemplateOptions(PipelineOptions):
    @classmethod
    def _add_argparse_args(cls, parser):
        # Required parameters
        parser.add_argument('--project', dest='project', required=True, help='GCP Project ID')
        parser.add_argument('--query', dest='query', required=True, help='BigQuery SQL query')
        parser.add_argument('--gcs_folder_path', dest='gcs_folder_path', required=True, help='Output GCS folder path')
        
        # Network configuration
        parser.add_argument('--network', dest='network', required=True, help='VPC network')
        parser.add_argument('--subnetwork', dest='subnetwork', required=True, help='VPC subnetwork')
        
        # Optional parameters with defaults
        parser.add_argument('--region', dest='region', default='us-east4', help='GCP project region')
        parser.add_argument('--service_account_email', dest='service_account_email', required=True, 
                          help='Service account email')
        parser.add_argument('--temp_location', dest='temp_location', required=True, help='Temp GCS bucket path')
        parser.add_argument('--staging_location', dest='staging_location', required=True, help='Staging GCS bucket path')

def run(argv=None):
    parser = argparse.ArgumentParser()
    known_args, pipeline_args = parser.parse_known_args(argv)
    
    pipeline_options = TemplateOptions(pipeline_args)
    pipeline_options.view_as(StandardOptions).runner = 'DataflowRunner'
    
    with beam.Pipeline(options=pipeline_options) as p:
        # Reading from BigQuery
        data = p | 'ReadFromBigQuery' >> beam.io.ReadFromBigQuery(
            query=pipeline_options.query,
            use_standard_sql=True
        )
        
        # Converting to CSV format
        csv_data = data | 'ConvertToCSV' >> beam.Map(
            lambda row: ','.join(str(x) for x in row.values())
        )
        
        # Writing to GCS
        csv_data | 'WriteToGCS' >> beam.io.WriteToText(
            f'{pipeline_options.gcs_folder_path}/output.csv',
            file_name_suffix='.csv',
            header="ont_activation_date,data_circuit_id,circuit_id,video_circuit_id,service_type,address_id,vision_account_id,vision_customer_id,address_type,line_of_business"
        )

if __name__ == '__main__':
    run()


    {
    "name": "BigQuery to GCS Pipeline",
    "description": "A pipeline that reads from BigQuery and writes to GCS",
    "parameters": [
        {
            "name": "query",
            "label": "BigQuery SQL query",
            "helpText": "SQL query to execute",
            "paramType": "TEXT",
            "isOptional": false
        },
        {
            "name": "gcs_folder_path",
            "label": "Output GCS folder path",
            "helpText": "GCS location to write output files",
            "paramType": "TEXT",
            "isOptional": false
        },
        {
            "name": "network",
            "label": "VPC Network",
            "helpText": "The VPC network to use",
            "paramType": "TEXT",
            "isOptional": false
        },
        {
            "name": "subnetwork",
            "label": "VPC Subnetwork",
            "helpText": "The VPC subnetwork to use",
            "paramType": "TEXT",
            "isOptional": false
        },
        {
            "name": "service_account_email",
            "label": "Service Account Email",
            "helpText": "Service account email to run the job",
            "paramType": "TEXT",
            "isOptional": false
        }
    ]
}


gcloud dataflow flex-template run "bigquery-pipeline-$(date +%Y%m%d-%H%M%S)" \
    --template-file-gcs-location gs://vznet-test/wireline_churn_test/src/template.json \
    --project vz-it-np-gudv-dev-vzntdo-0 \
    --region us-east4 \
    --parameters query="SELECT * FROM vz-it-np-gudv-dev-vzntdo-0.vzn_nsdl_common_core_tbls.echo_ticket_opened_proc_v0 LIMIT 10" \
    --parameters gcs_folder_path="gs://vznet-test/wireline_churn_test/tmp/" \
    --parameters network="shared-np-east" \
    --parameters subnetwork="https://www.googleapis.com/compute/v1/projects/vz-it-np-exhv-sharedvpc-228116/regions/us-east4/subnetworks/shared-np-east-green-subnet-2" \
    --parameters service_account_email="sa-dev-gudv-app-vzntdo-0@vz-it-np-gudv-dev-vzntdo-0.iam.gserviceaccount.com" \
    --num-workers 2 \
    --max-workers 2 \
    --worker-machine-type n2-standard-2 \
    --disable-public-ips \
    --temp-location gs://vznet-test/wireline_churn_test/tmp/ \
    --dataflow-kms-key projects/vz-it-np-d0sv-vsadkms-0/locations/us-east4/keyRings/vz-it-np-kr-aid/cryptoKeys/vz-it-np-kms-gudv




{"severity":"INFO","time":"2024/12/30 09:08:53.306101","line":"python_template_launcher.go:40","message":"Started template launcher."}
{"severity":"INFO","time":"2024/12/30 09:08:53.318937","line":"python_template_launcher.go:44","message":"Initialize Python template."}
{"severity":"INFO","time":"2024/12/30 09:08:53.318969","line":"python_template.go:98","message":"Falling back to using template-container args from metadata: template-container-args"}
{"severity":"INFO","time":"2024/12/30 09:08:53.321360","line":"python_template.go:108","message":"Validating template-container-args: {\"additionalBoolParameters\":[\"no_use_public_ips\"],\"consoleLogsLocation\":\"gs://dataflow-staging-us-east4-206482042907/staging/template_launches/2024-12-30_01_07_07-7510819455283454454/console_logs\",\"environment\":{\"network\":\"shared-np-east\",\"region\":\"us-east4\",\"serviceAccountEmail\":\"sa-dev-gudv-app-vzntdo-0@vz-it-np-gudv-dev-vzntdo-0.iam.gserviceaccount.com\",\"stagingLocation\":\"gs://dataflow-staging-us-east4-206482042907/staging\",\"subnetwork\":\"https://www.googleapis.com/compute/v1/projects/vz-it-np-exhv-sharedvpc-228116/regions/us-east4/subnetworks/shared-np-east-green-subnet-2\",\"tempLocation\":\"gs://vznet-test/wireline_churn_test/tmp/\"},\"jobId\":\"2024-12-30_01_07_07-7510819455283454454\",\"jobName\":\"bigquery-pipeline-20241230-040706\",\"jobObjectLocation\":\"gs://dataflow-staging-us-east4-206482042907/staging/template_launches/2024-12-30_01_07_07-7510819455283454454/job_object\",\"operationResultLocation\":\"gs://dataflow-staging-us-east4-206482042907/staging/template_launches/2024-12-30_01_07_07-7510819455283454454/operation_result\",\"parameters\":{\"dataflow_kms_key\":\"projects/vz-it-np-d0sv-vsadkms-0/locations/us-east4/keyRings/vz-it-np-kr-aid/cryptoKeys/vz-it-np-kms-gudv\",\"gcs_folder_path\":\"gs://vznet-test/wireline_churn_test/tmp/\",\"machine_type\":\"n2-standard-2\",\"max_num_workers\":\"2\",\"network\":\"shared-np-east\",\"num_workers\":\"2\",\"query\":\"SELECT * FROM vz-it-np-gudv-dev-vzntdo-0.vzn_nsdl_common_core_tbls.echo_ticket_opened_proc_v0 LIMIT 10\",\"service_account_email\":\"sa-dev-gudv-app-vzntdo-0@vz-it-np-gudv-dev-vzntdo-0.iam.gserviceaccount.com\",\"staging_location\":\"gs://dataflow-staging-us-east4-206482042907/staging\",\"subnetwork\":\"https://www.googleapis.com/compute/v1/projects/vz-it-np-exhv-sharedvpc-228116/regions/us-east4/subnetworks/shared-np-east-green-subnet-2\",\"temp_location\":\"gs://vznet-test/wireline_churn_test/tmp/\"},\"projectId\":\"vz-it-np-gudv-dev-vzntdo-0\"}"}
{"severity":"INFO","time":"2024/12/30 09:08:53.322432","line":"python_template.go:117","message":"Extracting operation result location."}
{"severity":"INFO","time":"2024/12/30 09:08:53.322479","line":"python_template.go:125","message":"Operation result location: gs://dataflow-staging-us-east4-206482042907/staging/template_launches/2024-12-30_01_07_07-7510819455283454454/operation_result"}
{"severity":"INFO","time":"2024/12/30 09:08:53.322499","line":"python_template.go:128","message":"Extracting console log location."}
{"severity":"INFO","time":"2024/12/30 09:08:53.322519","line":"python_template.go:136","message":"Console logs location: gs://dataflow-staging-us-east4-206482042907/staging/template_launches/2024-12-30_01_07_07-7510819455283454454/console_logs"}
{"severity":"INFO","time":"2024/12/30 09:08:53.322558","line":"python_template.go:139","message":"Extracting Python command specs."}
{"severity":"INFO","time":"2024/12/30 09:08:53.322998","line":"python_template.go:148","message":"Generating launch args."}
{"severity":"INFO","time":"2024/12/30 09:08:53.323121","line":"python_args.go:236","message":"Overriding staging_location with value: gs://dataflow-staging-us-east4-206482042907/staging (previous value: gs://dataflow-staging-us-east4-206482042907/staging)"}
{"severity":"INFO","time":"2024/12/30 09:08:53.323174","line":"python_args.go:236","message":"Overriding network with value: shared-np-east (previous value: shared-np-east)"}
{"severity":"INFO","time":"2024/12/30 09:08:53.323195","line":"python_args.go:236","message":"Overriding temp_location with value: gs://vznet-test/wireline_churn_test/tmp/ (previous value: gs://vznet-test/wireline_churn_test/tmp/)"}
{"severity":"INFO","time":"2024/12/30 09:08:53.323241","line":"python_args.go:236","message":"Overriding service_account_email with value: sa-dev-gudv-app-vzntdo-0@vz-it-np-gudv-dev-vzntdo-0.iam.gserviceaccount.com (previous value: sa-dev-gudv-app-vzntdo-0@vz-it-np-gudv-dev-vzntdo-0.iam.gserviceaccount.com)"}
{"severity":"INFO","time":"2024/12/30 09:08:53.323267","line":"python_args.go:236","message":"Overriding subnetwork with value: https://www.googleapis.com/compute/v1/projects/vz-it-np-exhv-sharedvpc-228116/regions/us-east4/subnetworks/shared-np-east-green-subnet-2 (previous value: https://www.googleapis.com/compute/v1/projects/vz-it-np-exhv-sharedvpc-228116/regions/us-east4/subnetworks/shared-np-east-green-subnet-2)"}
{"severity":"INFO","time":"2024/12/30 09:08:53.323330","line":"launch.go:50","message":"Validating ExpectedFeatures."}
{"severity":"INFO","time":"2024/12/30 09:08:53.323358","line":"launch.go:75","message":"Launching Python template."}
{"severity":"INFO","time":"2024/12/30 09:08:53.323416","line":"python_template.go:64","message":"Using launch args: [/template/pipeline.py --requirements_file=/template/requirements.txt --template_location=gs://dataflow-staging-us-east4-206482042907/staging/template_launches/2024-12-30_01_07_07-7510819455283454454/job_object --subnetwork=https://www.googleapis.com/compute/v1/projects/vz-it-np-exhv-sharedvpc-228116/regions/us-east4/subnetworks/shared-np-east-green-subnet-2 --region=us-east4 --gcs_folder_path=gs://vznet-test/wireline_churn_test/tmp/ --machine_type=n2-standard-2 --runner=DataflowRunner --project=vz-it-np-gudv-dev-vzntdo-0 --job_name=bigquery-pipeline-20241230-040706 --max_num_workers=2 --query=SELECT * FROM vz-it-np-gudv-dev-vzntdo-0.vzn_nsdl_common_core_tbls.echo_ticket_opened_proc_v0 LIMIT 10 --dataflow_kms_key=projects/vz-it-np-d0sv-vsadkms-0/locations/us-east4/keyRings/vz-it-np-kr-aid/cryptoKeys/vz-it-np-kms-gudv --num_workers=2 --service_account_email=sa-dev-gudv-app-vzntdo-0@vz-it-np-gudv-dev-vzntdo-0.iam.gserviceaccount.com --network=shared-np-east --temp_location=gs://vznet-test/wireline_churn_test/tmp/ --staging_location=gs://dataflow-staging-us-east4-206482042907/staging --no_use_public_ips]"}
{"severity":"INFO","time":"2024/12/30 09:08:53.323489","line":"exec.go:38","message":"Executing: python /template/pipeline.py --requirements_file=/template/requirements.txt --template_location=gs://dataflow-staging-us-east4-206482042907/staging/template_launches/2024-12-30_01_07_07-7510819455283454454/job_object --subnetwork=https://www.googleapis.com/compute/v1/projects/vz-it-np-exhv-sharedvpc-228116/regions/us-east4/subnetworks/shared-np-east-green-subnet-2 --region=us-east4 --gcs_folder_path=gs://vznet-test/wireline_churn_test/tmp/ --machine_type=n2-standard-2 --runner=DataflowRunner --project=vz-it-np-gudv-dev-vzntdo-0 --job_name=bigquery-pipeline-20241230-040706 --max_num_workers=2 --query=SELECT * FROM vz-it-np-gudv-dev-vzntdo-0.vzn_nsdl_common_core_tbls.echo_ticket_opened_proc_v0 LIMIT 10 --dataflow_kms_key=projects/vz-it-np-d0sv-vsadkms-0/locations/us-east4/keyRings/vz-it-np-kr-aid/cryptoKeys/vz-it-np-kms-gudv --num_workers=2 --service_account_email=sa-dev-gudv-app-vzntdo-0@vz-it-np-gudv-dev-vzntdo-0.iam.gserviceaccount.com --network=shared-np-east --temp_location=gs://vznet-test/wireline_churn_test/tmp/ --staging_location=gs://dataflow-staging-us-east4-206482042907/staging --no_use_public_ips"}
{"severity":"INFO","time":"2024/12/30 09:15:05.476612","line":"exec.go:66","message":"Traceback (most recent call last):"}
{"severity":"INFO","time":"2024/12/30 09:15:05.476789","line":"exec.go:66","message":"  File \"/usr/local/lib/python3.9/site-packages/apache_beam/utils/processes.py\", line 89, in check_output"}
{"severity":"INFO","time":"2024/12/30 09:15:05.477039","line":"exec.go:66","message":"    out = subprocess.check_output(*args, **kwargs)"}
{"severity":"INFO","time":"2024/12/30 09:15:05.477100","line":"exec.go:66","message":"  File \"/usr/local/lib/python3.9/subprocess.py\", line 424, in check_output"}
{"severity":"INFO","time":"2024/12/30 09:15:05.477357","line":"exec.go:66","message":"    return run(*popenargs, stdout=PIPE, timeout=timeout, check=True,"}
{"severity":"INFO","time":"2024/12/30 09:15:05.477450","line":"exec.go:66","message":"  File \"/usr/local/lib/python3.9/subprocess.py\", line 528, in run"}
{"severity":"INFO","time":"2024/12/30 09:15:05.477693","line":"exec.go:66","message":"    raise CalledProcessError(retcode, process.args,"}
{"severity":"INFO","time":"2024/12/30 09:15:05.477774","line":"exec.go:66","message":"subprocess.CalledProcessError: Command '['/usr/local/bin/python', '-m', 'pip', 'download', '--dest', '/tmp/dataflow-requirements-cache', '-r', '/tmp/tmp9imaw0wp/tmp_requirements.txt', '--exists-action', 'i', '--no-deps', '--implementation', 'cp', '--abi', 'cp39', '--platform', 'manylinux2014_x86_64']' returned non-zero exit status 1."}
{"severity":"INFO","time":"2024/12/30 09:15:05.477853","line":"exec.go:66","message":"During handling of the above exception, another exception occurred:"}
{"severity":"INFO","time":"2024/12/30 09:15:05.477896","line":"exec.go:66","message":"Traceback (most recent call last):"}
{"severity":"INFO","time":"2024/12/30 09:15:05.477931","line":"exec.go:66","message":"  File \"/template/pipeline.py\", line 54, in \u003cmodule\u003e"}
{"severity":"INFO","time":"2024/12/30 09:15:05.478086","line":"exec.go:66","message":"    run()"}
{"severity":"INFO","time":"2024/12/30 09:15:05.478138","line":"exec.go:66","message":"  File \"/template/pipeline.py\", line 47, in run"}
{"severity":"INFO","time":"2024/12/30 09:15:05.478264","line":"exec.go:66","message":"    csv_data | 'WriteToGCS' \u003e\u003e beam.io.WriteToText("}
{"severity":"INFO","time":"2024/12/30 09:15:05.478314","line":"exec.go:66","message":"  File \"/usr/local/lib/python3.9/site-packages/apache_beam/pipeline.py\", line 620, in __exit__"}
{"severity":"INFO","time":"2024/12/30 09:15:05.478600","line":"exec.go:66","message":"    self.result = self.run()"}
{"severity":"INFO","time":"2024/12/30 09:15:05.478651","line":"exec.go:66","message":"  File \"/usr/local/lib/python3.9/site-packages/apache_beam/pipeline.py\", line 567, in run"}
{"severity":"INFO","time":"2024/12/30 09:15:05.478908","line":"exec.go:66","message":"    return Pipeline.from_runner_api("}
{"severity":"INFO","time":"2024/12/30 09:15:05.478956","line":"exec.go:66","message":"  File \"/usr/local/lib/python3.9/site-packages/apache_beam/pipeline.py\", line 594, in run"}
{"severity":"INFO","time":"2024/12/30 09:15:05.479217","line":"exec.go:66","message":"    return self.runner.run_pipeline(self, self._options)"}
{"severity":"INFO","time":"2024/12/30 09:15:05.479306","line":"exec.go:66","message":"  File \"/usr/local/lib/python3.9/site-packages/apache_beam/runners/dataflow/dataflow_runner.py\", line 395, in run_pipeline"}
{"severity":"INFO","time":"2024/12/30 09:15:05.479547","line":"exec.go:66","message":"    artifacts = environments.python_sdk_dependencies(options)"}
{"severity":"INFO","time":"2024/12/30 09:15:05.479600","line":"exec.go:66","message":"  File \"/usr/local/lib/python3.9/site-packages/apache_beam/transforms/environments.py\", line 906, in python_sdk_dependencies"}
{"severity":"INFO","time":"2024/12/30 09:15:05.479921","line":"exec.go:66","message":"    return stager.Stager.create_job_resources("}
{"severity":"INFO","time":"2024/12/30 09:15:05.479975","line":"exec.go:66","message":"  File \"/usr/local/lib/python3.9/site-packages/apache_beam/runners/portability/stager.py\", line 246, in create_job_resources"}
{"severity":"INFO","time":"2024/12/30 09:15:05.480187","line":"exec.go:66","message":"    ("}
{"severity":"INFO","time":"2024/12/30 09:15:05.480240","line":"exec.go:66","message":"  File \"/usr/local/lib/python3.9/site-packages/apache_beam/utils/retry.py\", line 298, in wrapper"}
{"severity":"INFO","time":"2024/12/30 09:15:05.480460","line":"exec.go:66","message":"    return fun(*args, **kwargs)"}
{"severity":"INFO","time":"2024/12/30 09:15:05.480512","line":"exec.go:66","message":"  File \"/usr/local/lib/python3.9/site-packages/apache_beam/runners/portability/stager.py\", line 776, in _populate_requirements_cache"}
{"severity":"INFO","time":"2024/12/30 09:15:05.480839","line":"exec.go:66","message":"    processes.check_output(cmd_args, stderr=processes.STDOUT)"}
{"severity":"INFO","time":"2024/12/30 09:15:05.480891","line":"exec.go:66","message":"  File \"/usr/local/lib/python3.9/site-packages/apache_beam/utils/processes.py\", line 94, in check_output"}
{"severity":"INFO","time":"2024/12/30 09:15:05.481038","line":"exec.go:66","message":"    raise RuntimeError( \\"}
{"severity":"INFO","time":"2024/12/30 09:15:05.481093","line":"exec.go:66","message":"RuntimeError: Full traceback: Traceback (most recent call last):"}
{"severity":"INFO","time":"2024/12/30 09:15:05.481116","line":"exec.go:66","message":"  File \"/usr/local/lib/python3.9/site-packages/apache_beam/utils/processes.py\", line 89, in check_output"}
{"severity":"INFO","time":"2024/12/30 09:15:05.481131","line":"exec.go:66","message":"    out = subprocess.check_output(*args, **kwargs)"}
{"severity":"INFO","time":"2024/12/30 09:15:05.481156","line":"exec.go:66","message":"  File \"/usr/local/lib/python3.9/subprocess.py\", line 424, in check_output"}
{"severity":"INFO","time":"2024/12/30 09:15:05.481169","line":"exec.go:66","message":"    return run(*popenargs, stdout=PIPE, timeout=timeout, check=True,"}
{"severity":"INFO","time":"2024/12/30 09:15:05.481181","line":"exec.go:66","message":"  File \"/usr/local/lib/python3.9/subprocess.py\", line 528, in run"}
{"severity":"INFO","time":"2024/12/30 09:15:05.481193","line":"exec.go:66","message":"    raise CalledProcessError(retcode, process.args,"}
{"severity":"INFO","time":"2024/12/30 09:15:05.481205","line":"exec.go:66","message":"subprocess.CalledProcessError: Command '['/usr/local/bin/python', '-m', 'pip', 'download', '--dest', '/tmp/dataflow-requirements-cache', '-r', '/tmp/tmp9imaw0wp/tmp_requirements.txt', '--exists-action', 'i', '--no-deps', '--implementation', 'cp', '--abi', 'cp39', '--platform', 'manylinux2014_x86_64']' returned non-zero exit status 1."}
{"severity":"INFO","time":"2024/12/30 09:15:05.481224","line":"exec.go:66","message":" "}
{"severity":"INFO","time":"2024/12/30 09:15:05.481236","line":"exec.go:66","message":" Pip install failed for package: -r           "}
{"severity":"INFO","time":"2024/12/30 09:15:05.481249","line":"exec.go:66","message":" Output from execution of subprocess: b\"WARNING: Retrying (Retry(total=4, connect=None, read=None, redirect=None, status=None)) after connection broken by 'NewConnectionError('\u003cpip._vendor.urllib3.connection.HTTPSConnection object at 0x781464dcb1f0\u003e: Failed to establish a new connection: [Errno 101] Network is unreachable')': /simple/fastavro/\\nWARNING: Retrying (Retry(total=3, connect=None, read=None, redirect=None, status=None)) after connection broken by 'NewConnectionError('\u003cpip._vendor.urllib3.connection.HTTPSConnection object at 0x781464dcb520\u003e: Failed to establish a new connection: [Errno 101] Network is unreachable')': /simple/fastavro/\\nWARNING: Retrying (Retry(total=2, connect=None, read=None, redirect=None, status=None)) after connection broken by 'NewConnectionError('\u003cpip._vendor.urllib3.connection.HTTPSConnection object at 0x781464dcb790\u003e: Failed to establish a new connection: [Errno 101] Network is unreachable')': /simple/fastavro/\\nWARNING: Retrying (Retry(total=1, connect=None, read=None, redirect=None, status=None)) after connection broken by 'NewConnectionError('\u003cpip._vendor.urllib3.connection.HTTPSConnection object at 0x781464dcb940\u003e: Failed to establish a new connection: [Errno 101] Network is unreachable')': /simple/fastavro/\\nWARNING: Retrying (Retry(total=0, connect=None, read=None, redirect=None, status=None)) after connection broken by 'NewConnectionError('\u003cpip._vendor.urllib3.connection.HTTPSConnection object at 0x781464dcbaf0\u003e: Failed to establish a new connection: [Errno 101] Network is unreachable')': /simple/fastavro/\\nERROR: Could not find a version that satisfies the requirement fastavro (from versions: none)\\nERROR: No matching distribution found for fastavro\\n\""}
{"severity":"INFO","time":"2024/12/30 09:15:05.785524","line":"exec.go:52","message":"python failed with exit status 1"}
{"severity":"ERROR","time":"2024/12/30 09:15:05.785599","line":"launch.go:80","message":"Error: Template launch failed: exit status
