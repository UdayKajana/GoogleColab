import apache_beam as beam
from apache_beam.options.pipeline_options import PipelineOptions
from apache_beam.io.gcp.bigquery import ReadFromBigQuery
import logging

class CustomOptions(PipelineOptions):
    @classmethod
    def _add_argparse_args(cls, parser):
        parser.add_argument('--query', required=True, help='BigQuery SQL query to execute')

def run():
    """Main entry point."""
    logging.getLogger().setLevel(logging.INFO)

    pipeline_options = PipelineOptions()
    custom_options = pipeline_options.view_as(CustomOptions)

    # Logging the project and query
    logging.info(f"Starting pipeline with query: {custom_options.query}")

    # Create the pipeline
    with beam.Pipeline(options=pipeline_options) as pipeline:
        records = (
            pipeline 
            | 'ReadFromBigQuery' >> ReadFromBigQuery(
                query=custom_options.query,
                use_standard_sql=True)
        )

        transformed_records = records | 'ExampleTransform' >> beam.Map(lambda record: record)

if __name__ == '__main__':
    run()

python pipeline.py --query="SELECT * FROM `your_project_id.dataset.table` LIMIT 10"

   FROM gcr.io/dataflow-templates-base/python39-template-launcher-base
   WORKDIR /template

   COPY requirements.txt /template/requirements.txt
   COPY pipeline.py /template/pipeline.py

   RUN pip install --upgrade pip && \
       pip install --no-cache-dir -r /template/requirements.txt

   ENV FLEX_TEMPLATE_PYTHON_PY_FILE="/template/pipeline.py"
   ENV FLEX_TEMPLATE_PYTHON_REQUIREMENTS_FILE="/template/requirements.txt"
   ENV FLEX_TEMPLATE_PYTHON_OPTIONS="--runner=DataflowRunner --project=your_project_id --region=us-east4"

   
   gcloud builds submit --tag us-east4-docker.pkg.dev/your_project_id/vznet/pipeline_env:V2 .
   
   gcloud dataflow flex-template build gs://your_bucket/path/template.json \
   --image us-east4-docker.pkg.dev/your_project_id/vznet/pipeline_env:V2 \
   --sdk-language "PYTHON" \
   --metadata-file metadata.json
   
   gcloud dataflow flex-template run your-job-name \
   --template-file-gcs-location gs://your_bucket/path/template.json \
   --project your_project_id \
   --parameters query="SELECT * FROM `your_project_id.dataset.table` LIMIT 10"
   
